{"version":3,"sources":["tabbie.js"],"names":[],"mappings":"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","file":"tabbie.js","sourcesContent":["import uuid from 'uuid';\r\nimport Emitter from 'component-emitter';\r\n\r\nconst symbols = {\r\n  visibility: Symbol(),\r\n  storage: Symbol(),\r\n  window: Symbol(),\r\n  enabled: Symbol(),\r\n  id: Symbol(),\r\n  heartbeat: Symbol(),\r\n  emitter: Symbol(),\r\n  prefix: Symbol(),\r\n  gc: Symbol(),\r\n};\r\n\r\n\r\nconst HEARTBEAT_INTERVAL = 500;\r\n// heatbeat older than HEARTBEAT_EXPIRE will be gc'ed\r\nconst HEARTBEAT_EXPIRE = 2000;\r\nconst GC_INTERVAL = 5000;\r\n\r\n/* global window Visibility localStorage */\r\n\r\n\r\n/**\r\n * @function\r\n */\r\nfunction heartbeat() {\r\n  this[symbols.storage].setItem(`${this.prefix}-beat-${this.id}`, Date.now());\r\n}\r\n/**\r\n * @function\r\n * @return {String|Array} Array of available keys in the storage\r\n */\r\nfunction storageKeys() {\r\n  const length = this.storage.length;\r\n  const keys = new Set();\r\n  for (let i = 0; i < length; i++) {\r\n    const key = this.storage.key(i);\r\n    if (key !== null) keys.add(key);\r\n  }\r\n  return [...keys];\r\n}\r\n/**\r\n * @function\r\n * @description Search storage for expired tab heartbeat keys and delete them\r\n */\r\nfunction gc() {\r\n  const expiredCut = Date.now() - HEARTBEAT_EXPIRE;\r\n  const regex = new RegExp(`^${this.prefix}-beat`);\r\n  this::storageKeys().forEach(key => {\r\n    if (regex.test(key) && this.storage.getItem(key) < expiredCut) {\r\n      this.storage.removeItem(key);\r\n    }\r\n  });\r\n}\r\n\r\n\r\nexport default class Tabbie {\r\n  constructor({\r\n    visibility,\r\n    storage,\r\n    windowObject,\r\n    prefix = 'tabbie',\r\n  }) {\r\n    if (visibility) {\r\n      this[symbols.visibility] = visibility;\r\n    } else if (typeof Visibility !== 'undefined') {\r\n      this[symbols.visibility] = Visibility;\r\n    }\r\n\r\n    if (storage) {\r\n      this[symbols.storage] = storage;\r\n    } else if (typeof localStorage !== 'undefined') {\r\n      this[symbols.storage] = localStorage;\r\n    }\r\n\r\n    if (windowObject) {\r\n      this[symbols.window] = windowObject;\r\n    } else if (typeof window !== 'undefined') {\r\n      this[symbols.window] = window;\r\n    }\r\n\r\n    this[symbols.prefix] = prefix;\r\n\r\n    this[symbols.enabled] = !!(\r\n      this[symbols.visibility] &&\r\n      this[symbols.storage] &&\r\n      this[symbols.window]\r\n    );\r\n\r\n    this[symbols.id] = uuid.v4();\r\n    this[symbols.emitter] = new Emitter();\r\n\r\n    if (this.isEnabled) {\r\n      // setup heartbeat;\r\n      this[symbols.heartbeat] = setInterval(this::heartbeat, HEARTBEAT_INTERVAL);\r\n      this::heartbeat();\r\n\r\n      this[symbols.gc] = setInterval(this::gc, GC_INTERVAL);\r\n    }\r\n  }\r\n  get isEnabled() {\r\n    return this[symbols.enabled];\r\n  }\r\n  // get isActive() {\r\n  //   return this[]\r\n  // }\r\n\r\n  get id() {\r\n    return this[symbols.id];\r\n  }\r\n\r\n  get storage() {\r\n    return this[symbols.storage];\r\n  }\r\n\r\n  get prefix() {\r\n    return this[symbols.prefix];\r\n  }\r\n\r\n  emit(event, ...args) {\r\n    if (this.isEnabled) {\r\n      const id = uuid.v4();\r\n      const key = `tabbie-event-${id}`;\r\n      const payload = [event, ...args];\r\n      this.storage.setItem(key, JSON.stringify(payload));\r\n      this.storage.removeItem(key);\r\n    }\r\n  }\r\n\r\n  on(...args) {\r\n    this[symbols.emitter].on(...args);\r\n  }\r\n  off(...args) {\r\n    this[symbols.emitter].off(...args);\r\n  }\r\n  addEventListener(...args) {\r\n    this[symbols.emitter].addEventListener(...args);\r\n  }\r\n  removeEventListener(...args) {\r\n    this[symbols.emitter].removeEventListener(...args);\r\n  }\r\n  once(...args) {\r\n    this[symbols.emitter].once(...args);\r\n  }\r\n\r\n}\r\n"],"sourceRoot":"/source/"}